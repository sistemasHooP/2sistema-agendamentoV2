<script>
// ========================================================
// ARQUIVO: JavaScript-Master.html
// Contém todas as funções de renderização para as telas do perfil Master.
// ========================================================
Object.assign(App, {
    renderMasterDashboard() {
        document.getElementById('view-title').textContent = 'Dashboard';
        const container = this.elements.mainContent;
        if (!this.state.data.dashboardStats) {
            container.innerHTML = `<div class="flex justify-center items-center p-8"><i class="fa-solid fa-spinner animate-spin text-2xl text-slate-400 mr-3"></i><span class="text-slate-500">Carregando estatísticas...</span></div>`;
            return;
        }
        const stats = this.state.data.dashboardStats;
        const statusCounts = stats.status || {};
        const statusHtml = Object.entries(statusCounts).map(([key, value]) => `<div class="flex justify-between items-center py-2 border-b border-slate-100"><span class="status-${key || 'default'}">${key}</span><span class="font-semibold text-slate-700">${value}</span></div>`).join('');
        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">Hoje</h3><p class="text-4xl font-bold text-blue-600 mt-2">${stats.today || 0}</p></div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">Este Mês</h3><p class="text-4xl font-bold text-slate-800 mt-2">${stats.month || 0}</p></div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="text-slate-500 text-sm font-medium">Este Ano</h3><p class="text-4xl font-bold text-slate-800 mt-2">${stats.year || 0}</p></div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200"><h3 class="text-slate-500 text-sm font-medium mb-3">Status Gerais</h3><div class="max-h-32 overflow-y-auto pr-2">${statusHtml}</div></div>
            </div>
            <div class="mt-6 bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <h3 class="text-lg font-semibold text-slate-800 mb-4">Distribuição de Status</h3>
                <div class="relative mx-auto" style="height: 300px;"><canvas id="statusChart"></canvas></div>
            </div>`;
        const colorMap = { 'Confirmado': '#22c55e', 'Pendente': '#f59e0b', 'Concluído': '#3b82f6', 'Cancelado': '#ef4444', 'Chamado': '#a855f7', 'Sem Status': '#64748b' };
        const chartLabels = Object.keys(statusCounts);
        this.initChart('statusChart', 'doughnut', { labels: chartLabels, datasets: [{ data: Object.values(statusCounts), backgroundColor: chartLabels.map(label => colorMap[label] || colorMap['Sem Status']), borderColor: '#fff', borderWidth: 2 }] }, { plugins: { legend: { position: 'bottom', labels: { color: '#475569' } } } });
    },

    renderMasterProfessionals() {
        document.getElementById('view-title').textContent = 'Profissionais';
        const container = this.elements.mainContent;
        const tableRows = this.state.data.professionals.map(prof => `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="p-4 font-medium text-slate-800">${prof.Nome_Completo}</td>
                <td class="p-4 text-slate-600">${prof.Especialidade}</td>
                <td class="p-4 text-slate-600">${prof.Contato_Email}</td>
                <td class="p-4"><span class="status-${prof.Status || 'default'}">${prof.Status}</span></td>
                <td class="p-4 text-right"><button class="btn btn-secondary !py-1 !px-3" data-id="${prof.ID_Profissional}">Editar</button></td>
            </tr>`).join('');
        container.innerHTML = `
            <div class="bg-white rounded-xl shadow-md border border-slate-200">
                <div class="flex justify-between items-center p-4 border-b border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800">Gerenciar Profissionais</h3>
                    <button id="addProfessionalBtn" class="btn btn-primary"><i class="fa-solid fa-plus mr-2"></i> Adicionar</button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left">
                    <thead class="bg-slate-50"><tr>
                        <th class="p-4 font-semibold text-slate-600 text-sm">Nome</th><th class="p-4 font-semibold text-slate-600 text-sm">Especialidade</th>
                        <th class="p-4 font-semibold text-slate-600 text-sm">Email</th><th class="p-4 font-semibold text-slate-600 text-sm">Status</th>
                        <th class="p-4 font-semibold text-slate-600 text-sm text-right">Ações</th>
                    </tr></thead>
                    <tbody>${tableRows || '<tr><td colspan="5" class="p-8 text-center text-slate-500">Nenhum profissional encontrado.</td></tr>'}</tbody>
                </table></div>
            </div>`;
        container.querySelector('#addProfessionalBtn').addEventListener('click', () => this.renderProfessionalForm());
        container.querySelector('tbody').addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.id) this.renderProfessionalForm(e.target.dataset.id);
        });
    },

    renderProfessionalForm(profId = null) {
        const isEditing = profId !== null;
        const prof = isEditing ? this.state.data.professionals.find(p => p.ID_Profissional === profId) : {};
        const title = isEditing ? 'Editar Profissional' : 'Adicionar Novo Profissional';
        
        const weekDays = ['Segunda_feira', 'Terca_feira', 'Quarta_feira', 'Quinta_feira', 'Sexta_feira', 'Sabado', 'Domingo'];
        const weekDaysShort = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'];
        
        const workdaysHtml = weekDays.map((day, i) => {
            const works = prof[day] === 'SIM';
            return `
                <div class="p-3 border border-slate-200 rounded-lg flex items-center justify-between">
                    <label for="${day}" class="font-semibold text-slate-700">${weekDaysShort[i]}</label>
                    <label class="toggle-switch">
                        <input id="${day}" type="checkbox" ${works ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>`;
        }).join('');
        
        const formHTML = `
            <form id="profForm">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="form-label">Nome Completo</label><input type="text" id="profNome" class="form-input" value="${prof.Nome_Completo || ''}" required></div>
                        <div><label class="form-label">Especialidade</label><input type="text" id="profEspecialidade" class="form-input" value="${prof.Especialidade || ''}" required></div>
                        <div><label class="form-label">Email de Contato (Login)</label><input type="email" id="profEmail" class="form-input" value="${prof.Contato_Email || ''}" required></div>
                        <div><label class="form-label">Email da Agenda Google</label><input type="email" id="profEmailAgenda" class="form-input" value="${prof.Email_Agenda || ''}"></div>
                        <div><label class="form-label">Telefone</label><input type="tel" id="profTelefone" class="form-input" value="${prof.Contato_Telefone || ''}"></div>
                        <div><label class="form-label">Senha</label><input type="password" id="profSenha" placeholder="Deixe em branco para não alterar" class="form-input"></div>
                        <div><label class="form-label">Sala de Atendimento</label><input type="text" id="profSala" class="form-input" value="${prof.Sala_Atendimento || ''}"></div>
                        <div><label class="form-label">Grupo de Agenda</label><input type="text" id="profGrupo" class="form-input" value="${prof.Grupo_Agenda || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <div><label class="form-label">Status</label><select id="profStatus" class="form-select"><option value="Ativo" ${prof.Status === 'Ativo' ? 'selected' : ''}>Ativo</option><option value="Inativo" ${prof.Status === 'Inativo' ? 'selected' : ''}>Inativo</option></select></div>
                        <div class="flex items-center pt-6"><input id="profReceberEmail" type="checkbox" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500" ${prof.Receber_Email_Agendamento === 'SIM' ? 'checked' : ''}><label for="profReceberEmail" class="ml-2 text-sm">Receber e-mail de notificação</label></div>
                    </div>
                    <fieldset class="border-t border-slate-200 pt-4">
                        <legend class="text-md font-semibold text-slate-700">Dias de Trabalho</legend>
                        <p class="text-xs text-slate-500 mb-4">Marque os dias em que o profissional trabalha.</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${workdaysHtml}</div>
                    </fieldset>
                </div>
                <div class="flex justify-end gap-4 pt-6 border-t border-slate-200 mt-6">
                    <button type="button" class="btn btn-secondary" onclick="App.closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>`;
        this.openModal(title, formHTML, 'max-w-4xl');

        document.getElementById('profForm').addEventListener('submit', async e => {
            e.preventDefault();
            this.showLoader('Salvando...');
            const form = e.target;
            const profData = {
                Nome_Completo: form.querySelector('#profNome').value, Especialidade: form.querySelector('#profEspecialidade').value,
                Contato_Email: form.querySelector('#profEmail').value, Email_Agenda: form.querySelector('#profEmailAgenda').value,
                Contato_Telefone: form.querySelector('#profTelefone').value, Senha: form.querySelector('#profSenha').value,
                Status: form.querySelector('#profStatus').value, Receber_Email_Agendamento: form.querySelector('#profReceberEmail').checked ? 'SIM' : 'NAO',
                Sala_Atendimento: form.querySelector('#profSala').value, Grupo_Agenda: form.querySelector('#profGrupo').value
            };
            
            weekDays.forEach(day => {
                profData[day] = form.querySelector(`#${day}`).checked ? 'SIM' : '';
            });
            
            try {
                const response = isEditing ? await callApi('editProfessional', { profId, profData }) : await callApi('addProfessional', { profData });
                if (response.success) {
                    this.showNotification('success', 'Sucesso!', `Profissional ${isEditing ? 'atualizado' : 'adicionado'}.`);
                    await this.refreshData('master-professionals');
                    this.closeModal();
                } else { throw new Error(response.message); }
            } catch (err) { this.showNotification('error', 'Erro', err.message); } finally { this.hideLoader(); }
        });
    },

    renderMasterAppointments() {
        document.getElementById('view-title').textContent = 'Agendamentos';
        const container = this.elements.mainContent;
        const profOptions = this.state.data.professionals.map(p => `<option value="${p.ID_Profissional}">${p.Nome_Completo}</option>`).join('');
        container.innerHTML = `
            <div class="bg-white p-4 rounded-xl shadow-md border border-slate-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div><label class="form-label">De:</label><input type="date" id="filterStartDate" class="form-input"></div>
                    <div><label class="form-label">Até:</label><input type="date" id="filterEndDate" class="form-input"></div>
                    <div><label class="form-label">Profissional:</label><select id="filterProfessional" class="form-select"><option value="">Todos</option>${profOptions}</select></div>
                    <div><label class="form-label">Status:</label><select id="filterStatus" class="form-select"><option value="">Todos</option><option>Pendente</option><option>Confirmado</option><option>Chamado</option><option>Concluído</option><option>Cancelado</option></select></div>
                    <div class="flex gap-2"><button id="filterBtn" class="btn btn-primary w-full">Filtrar</button><button id="generatePdfBtn" class="btn btn-secondary" title="Gerar PDF"><i class="fa-solid fa-file-pdf"></i></button></div>
                </div>
            </div>
            <div id="appointments-table-container" class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden"></div>`;

        const fetchAndRender = async () => {
            this.showLoader('Buscando agendamentos...');
            const filters = {
                start: container.querySelector('#filterStartDate').value,
                end: container.querySelector('#filterEndDate').value,
                prof: container.querySelector('#filterProfessional').value,
                status: container.querySelector('#filterStatus').value
            };
            try {
                const options = { page: this.state.appointments.currentPage, pageSize: this.state.appointments.pageSize, filters };
                const response = await callApi('getPaginatedAppointments', { options });
                this.state.appointments.data = response.appointments;
                this.state.appointments.totalCount = response.totalCount;
                this.renderAppointmentsTable();
            } catch (err) { this.showNotification('error', 'Erro', err.message); } finally { this.hideLoader(); }
        };
        
        container.querySelector('#filterBtn').addEventListener('click', () => { this.state.appointments.currentPage = 1; fetchAndRender(); });
        container.querySelector('#generatePdfBtn').addEventListener('click', this.generatePDF.bind(this));
        
        container.querySelector('#appointments-table-container').addEventListener('click', e => {
            const button = e.target.closest('button[data-id]');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
            if (action === 'edit') {
                this.renderAppointmentEditForm(id, 'master-appointments');
            } else if (action === 'delete') {
                this.confirmAction('Tem certeza que deseja excluir este agendamento?', () => this.handleDeleteAppointment(id, 'master-appointments'));
            }
        });

        fetchAndRender();
    },

    renderAppointmentsTable() {
        const container = document.getElementById('appointments-table-container');
        const { data, totalCount, currentPage, pageSize } = this.state.appointments;
        const professionals = this.state.data.professionals;

        const tableRows = data.length > 0 ? data.map(a => {
            const prof = professionals.find(p => p.ID_Profissional === a.ID_Profissional);
            const [year, month, day] = a.Data.split('-');
            const canEditOrDelete = a.Status === 'Confirmado' || a.Status === 'Pendente';
            return `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="p-4"><div class="font-medium text-slate-800">${a.Nome_Cliente}</div><div class="text-sm text-slate-500">${a.Telefone_WhatsApp || ''}</div></td>
                <td class="p-4 text-slate-600">${a.Servico}</td>
                <td class="p-4 text-slate-600">${prof ? prof.Nome_Completo : 'N/A'}</td>
                <td class="p-4 text-slate-600">${day}/${month}/${year} às ${a.Hora}</td>
                <td class="p-4"><span class="status-${a.Status || 'default'}">${a.Status}</span></td>
                <td class="p-4 text-right">
                    <div class="flex items-center justify-end gap-2">
                        <button data-action="edit" data-id="${a.ID_Agendamento}" class="btn btn-secondary !p-2" title="Editar" ${!canEditOrDelete ? 'disabled' : ''}><i class="fa-solid fa-pencil"></i></button>
                        <button data-action="delete" data-id="${a.ID_Agendamento}" class="btn btn-danger !p-2" title="Excluir" ${!canEditOrDelete ? 'disabled' : ''}><i class="fa-solid fa-trash"></i></button>
                    </div>
                </td>
            </tr>`;
        }).join('') : `<tr><td colspan="6" class="p-8 text-center text-slate-500">Nenhum agendamento encontrado.</td></tr>`;

        const totalPages = Math.ceil(totalCount / pageSize);
        let paginationHtml = '';
        if (totalPages > 1) {
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<button class="px-4 py-2 rounded-md ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-slate-200 hover:bg-slate-300'}" onclick="App.changeAppointmentsPage(${i})">${i}</button>`;
            }
        }

        container.innerHTML = `
            <div class="overflow-x-auto"><table class="w-full text-left">
                <thead class="bg-slate-50"><tr>
                    <th class="p-4 font-semibold text-slate-600 text-sm">Cliente</th>
                    <th class="p-4 font-semibold text-slate-600 text-sm">Serviço</th>
                    <th class="p-4 font-semibold text-slate-600 text-sm">Profissional</th>
                    <th class="p-4 font-semibold text-slate-600 text-sm">Data/Hora</th>
                    <th class="p-4 font-semibold text-slate-600 text-sm">Status</th>
                    <th class="p-4 font-semibold text-slate-600 text-sm text-right">Ações</th>
                </tr></thead><tbody>${tableRows}</tbody>
            </table></div>
            <div class="p-4 flex justify-between items-center text-sm text-slate-500">
                <div>Mostrando ${data.length} de ${totalCount} registros</div>
                <div class="flex space-x-2">${paginationHtml}</div>
            </div>`;
    },

    changeAppointmentsPage(page) {
        this.state.appointments.currentPage = page;
        this.renderMasterAppointments();
    },

    async generatePDF() {
        this.showLoader('Gerando PDF...');
        const filters = {
            start: document.getElementById('filterStartDate').value, end: document.getElementById('filterEndDate').value,
            prof: document.getElementById('filterProfessional').value, status: document.getElementById('filterStatus').value
        };
        try {
            const result = await callApi('generateAppointmentsPDF', { filters });
            if (result.success) {
                const link = document.createElement('a');
                link.href = `data:${result.mimeType};base64,${result.data}`;
                link.download = result.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showNotification('success', 'Sucesso', 'Relatório PDF gerado.');
            } else { throw new Error(result.message); }
        } catch (err) { this.showNotification('error', 'Erro ao gerar PDF', err.message); } finally { this.hideLoader(); }
    },

    async renderAppointmentEditForm(appointmentId, returnView) {
        this.showLoader('Carregando dados...');
        try {
            const response = await callApi('getAppointmentDetails', { appointmentId });
            if (!response.success) {
                throw new Error(response.message);
            }
            const appt = response.appointment;

            const profOptions = this.state.data.professionals
                .filter(p => p.Status === 'Ativo')
                .map(p => `<option value="${p.ID_Profissional}" ${p.ID_Profissional === appt.ID_Profissional ? 'selected' : ''}>${p.Nome_Completo}</option>`)
                .join('');
            const serviceOptions = this.state.data.services
                .map(s => `<option value="${s.Nome_Servico}" ${s.Nome_Servico === appt.Servico ? 'selected' : ''}>${s.Nome_Servico}</option>`)
                .join('');

            const formHTML = `
                <form id="editAppointmentForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="form-label">Nome do Cliente</label><input type="text" id="editClientName" class="form-input" value="${appt.Nome_Cliente}" required></div>
                        <div><label class="form-label">Telefone</label><input type="tel" id="editClientPhone" class="form-input" value="${appt.Telefone_WhatsApp || ''}"></div>
                        <div><label class="form-label">Data</label><input type="date" id="editApptDate" class="form-input" value="${appt.Data}" required></div>
                        <div><label class="form-label">Hora</label><input type="time" id="editApptTime" class="form-input" value="${appt.Hora}" required></div>
                        <div class="md:col-span-2"><label class="form-label">Profissional</label><select id="editProfessional" class="form-select">${profOptions}</select></div>
                        <div class="md:col-span-2"><label class="form-label">Serviço</label><select id="editService" class="form-select">${serviceOptions}</select></div>
                        <div class="md:col-span-2"><label class="form-label">Observações</label><textarea id="editObs" rows="2" class="form-input">${appt.Observacoes || ''}</textarea></div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4 border-t border-slate-200 mt-4">
                        <button type="button" class="btn btn-secondary" onclick="App.closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </div>
                </form>
            `;

            this.openModal('Editar Agendamento', formHTML, 'max-w-2xl');
            this.hideLoader();

            document.getElementById('editAppointmentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                this.showLoader('Salvando...');
                
                const form = e.target;
                const appointmentData = {
                    ...appt, 
                    Nome_Cliente: form.querySelector('#editClientName').value,
                    Telefone_WhatsApp: form.querySelector('#editClientPhone').value,
                    Data: form.querySelector('#editApptDate').value,
                    Hora: form.querySelector('#editApptTime').value,
                    ID_Profissional: form.querySelector('#editProfessional').value,
                    Servico: form.querySelector('#editService').value,
                    Observacoes: form.querySelector('#editObs').value
                };

                try {
                    const updateResponse = await callApi('updateAppointment', { appointmentId, appointmentData });
                    if (updateResponse.success) {
                        this.showNotification('success', 'Sucesso!', 'Agendamento atualizado.');
                        this.closeModal();
                        await this.refreshData(returnView);
                    } else {
                        throw new Error(updateResponse.message);
                    }
                } catch (err) {
                    this.showNotification('error', 'Erro ao Salvar', err.message);
                } finally {
                    this.hideLoader();
                }
            });

        } catch (err) {
            this.showNotification('error', 'Erro ao carregar', err.message);
            this.hideLoader();
        }
    },

    async handleDeleteAppointment(appointmentId, returnView) {
        this.showLoader('Excluindo...');
        try {
            const response = await callApi('deleteAppointment', { appointmentId });
            if (response.success) {
                this.showNotification('success', 'Sucesso!', 'Agendamento excluído.');
                await this.refreshData(returnView);
            } else {
                throw new Error(response.message);
            }
        } catch (err) {
            this.showNotification('error', 'Erro ao excluir', err.message);
        } finally {
            this.hideLoader();
        }
    },

    renderMasterAttendants() {
        document.getElementById('view-title').textContent = 'Atendentes';
        const container = this.elements.mainContent;
        const tableRows = this.state.data.users.attendant.map(user => `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="p-4 font-medium text-slate-800">${user.Usuario}</td>
                <td class="p-4 text-right space-x-2">
                    <button class="btn btn-secondary !py-1 !px-3" data-action="edit" data-user="${user.Usuario}">Editar</button>
                    <button class="btn btn-danger !py-1 !px-3" data-action="delete" data-user="${user.Usuario}">Excluir</button>
                </td>
            </tr>`).join('');
        container.innerHTML = `
            <div class="bg-white rounded-xl shadow-md border border-slate-200">
                <div class="flex justify-between items-center p-4 border-b border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800">Gerenciar Atendentes</h3>
                    <button id="addAttendantBtn" class="btn btn-primary"><i class="fa-solid fa-plus mr-2"></i> Adicionar</button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left">
                    <thead class="bg-slate-50"><tr><th class="p-4 font-semibold text-slate-600 text-sm">Usuário</th><th class="p-4 font-semibold text-slate-600 text-sm text-right">Ações</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                </table></div>
            </div>`;
        container.querySelector('#addAttendantBtn').addEventListener('click', () => this.renderAttendantForm());
        container.querySelector('tbody').addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const action = e.target.dataset.action;
                const username = e.target.dataset.user;
                if (action === 'edit') this.renderAttendantForm(username);
                else if (action === 'delete') this.confirmAction(`Deseja excluir o atendente "${username}"?`, () => this.handleDeleteAttendant(username));
            }
        });
    },

    renderAttendantForm(username = null) {
        const isEditing = username !== null;
        const title = isEditing ? 'Editar Atendente' : 'Adicionar Atendente';
        const formHTML = `
            <form id="attendantForm" class="space-y-4">
                <div><label class="form-label">Usuário</label><input type="text" id="attendantUser" value="${username || ''}" class="form-input mt-1" required></div>
                <div><label class="form-label">Nova Senha</label><input type="password" id="attendantPass" placeholder="${isEditing ? 'Deixe em branco para não alterar' : ''}" class="form-input mt-1"></div>
                <div class="flex justify-end gap-4 pt-4 border-t border-slate-200 mt-4">
                    <button type="button" class="btn btn-secondary" onclick="App.closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>`;
        this.openModal(title, formHTML);
        document.getElementById('attendantForm').addEventListener('submit', async e => {
            e.preventDefault();
            const newData = { Usuario: document.getElementById('attendantUser').value, Senha: document.getElementById('attendantPass').value };
            if (!newData.Usuario || (!isEditing && !newData.Senha)) { this.showNotification('error', 'Erro', 'Usuário e senha são obrigatórios.'); return; }
            this.showLoader('Salvando...');
            try {
                const response = isEditing ? await callApi('editAttendant', { originalUsername: username, newData }) : await callApi('addAttendant', { attendantData: newData });
                if (response.success) {
                    this.showNotification('success', 'Sucesso!', `Atendente ${isEditing ? 'atualizado' : 'adicionado'}.`);
                    await this.refreshData('master-attendants');
                    this.closeModal();
                } else { throw new Error(response.message); }
            } catch (err) { this.showNotification('error', 'Erro', err.message); } finally { this.hideLoader(); }
        });
    },

    async handleDeleteAttendant(username) {
        this.showLoader('Excluindo...');
        try {
            const response = await callApi('deleteAttendant', { username });
            if (response.success) {
                this.showNotification('success', 'Sucesso!', 'Atendente excluído.');
                await this.refreshData('master-attendants');
            } else { throw new Error(response.message); }
        } catch (err) { this.showNotification('error', 'Erro', err.message); } finally { this.hideLoader(); }
    },

    renderMasterServices() {
        document.getElementById('view-title').textContent = 'Serviços';
        const container = this.elements.mainContent;
        const tableRows = this.state.data.services.map(s => `
            <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="p-4 font-medium text-slate-800">${s.Nome_Servico}</td>
                <td class="p-4 text-right space-x-2">
                    <button class="btn btn-secondary !py-1 !px-3" data-action="edit" data-name="${s.Nome_Servico}">Editar</button>
                    <button class="btn btn-danger !py-1 !px-3" data-action="delete" data-name="${s.Nome_Servico}">Excluir</button>
                </td>
            </tr>`).join('');
        container.innerHTML = `
            <div class="bg-white rounded-xl shadow-md border border-slate-200">
                <div class="flex justify-between items-center p-4 border-b border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800">Gerenciar Serviços</h3>
                    <button id="addServiceBtn" class="btn btn-primary"><i class="fa-solid fa-plus mr-2"></i> Adicionar</button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left">
                    <thead class="bg-slate-50"><tr><th class="p-4 font-semibold text-slate-600 text-sm">Nome do Serviço</th><th class="p-4 font-semibold text-slate-600 text-sm text-right">Ações</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                </table></div>
            </div>`;
        container.querySelector('#addServiceBtn').addEventListener('click', () => this.renderServiceForm());
        container.querySelector('tbody').addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const action = e.target.dataset.action;
                const name = e.target.dataset.name;
                if (action === 'edit') this.renderServiceForm(name);
                else if (action === 'delete') this.confirmAction(`Deseja excluir o serviço "${name}"?`, () => this.handleDeleteService(name));
            }
        });
    },

    renderServiceForm(serviceName = null) {
        const isEditing = serviceName !== null;
        const title = isEditing ? 'Editar Serviço' : 'Adicionar Serviço';
        const formHTML = `
            <form id="serviceForm" class="space-y-4">
                <div><label class="form-label">Nome do Serviço</label><input type="text" id="serviceName" value="${serviceName || ''}" class="form-input mt-1" required></div>
                <div class="flex justify-end gap-4 pt-4 border-t border-slate-200 mt-4">
                    <button type="button" class="btn btn-secondary" onclick="App.closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>`;
        this.openModal(title, formHTML);
        document.getElementById('serviceForm').addEventListener('submit', async e => {
            e.preventDefault();
            const newName = document.getElementById('serviceName').value;
            if (!newName) { this.showNotification('error', 'Erro', 'O nome do serviço é obrigatório.'); return; }
            this.showLoader('Salvando...');
            try {
                const response = isEditing ? await callApi('editService', { originalName: serviceName, newName }) : await callApi('addService', { serviceName: newName });
                if (response.success) {
                    this.showNotification('success', 'Sucesso!', `Serviço ${isEditing ? 'atualizado' : 'adicionado'}.`);
                    await this.refreshData('master-services');
                    this.closeModal();
                } else { throw new Error(response.message); }
            } catch (err) { this.showNotification('error', 'Erro', err.message); } finally { this.hideLoader(); }
        });
    },

    async handleDeleteService(serviceName) {
        this.showLoader('Excluindo...');
        try {
            const response = await callApi('deleteService', { serviceName });
            if (response.success) {
                this.showNotification('success', 'Sucesso!', 'Serviço excluído.');
                await this.refreshData('master-services');
            } else { throw new Error(response.message); }
        } catch (err) { this.showNotification('error', 'Erro', err.message); } finally { this.hideLoader(); }
    },

    renderMasterSettings() {
        document.getElementById('view-title').textContent = 'Configurações';
        const container = this.elements.mainContent;

        const configsToShow = this.state.data.config.filter(conf => SETTINGS_MAP[conf.Chave]);
        const helpMessageConfig = configsToShow.find(c => c.Chave === 'HELP_MESSAGE');
        const generalConfigs = configsToShow.filter(c => c.Chave !== 'HELP_MESSAGE');

        const tableRows = generalConfigs.map(conf => {
            const mapping = SETTINGS_MAP[conf.Chave];
            if (!mapping) return '';

            if (mapping.type === 'toggle') {
                const isChecked = conf.Valor === 'SIM';
                return `
                    <tr class="border-b border-slate-100" data-key="${conf.Chave}">
                        <td class="p-4 align-top">
                            <div class="font-medium text-slate-800">${mapping.label}</div>
                            <div class="text-xs text-slate-500 mt-1">${mapping.description}</div>
                        </td>
                        <td class="p-4 align-top">
                            <label class="toggle-switch">
                                <input type="checkbox" class="setting-toggle" ${isChecked ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </td>
                        <td class="p-4 text-right align-top">
                            <span class="font-medium text-sm ${isChecked ? 'text-green-600' : 'text-slate-500'}">
                                ${isChecked ? 'Ativado' : 'Desativado'}
                            </span>
                        </td>
                    </tr>`;
            }

            return `
                <tr class="border-b border-slate-100" data-key="${conf.Chave}">
                    <td class="p-4">
                        <div class="font-medium text-slate-800">${mapping.label}</div>
                        <div class="text-xs text-slate-500 mt-1">${mapping.description}</div>
                    </td>
                    <td class="p-4">
                        <span class="text-slate-600">${conf.Valor}</span>
                    </td>
                    <td class="p-4 text-right">
                        <button class="btn btn-secondary !py-1 !px-3" data-action="edit">Editar</button>
                    </td>
                </tr>`;
        }).join('');

        container.innerHTML = `
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-md border border-slate-200">
                    <div class="p-4 border-b border-slate-200"><h3 class="text-lg font-semibold text-slate-800">Configurações Gerais</h3></div>
                    <div class="overflow-x-auto"><table class="w-full text-left">
                        <thead class="bg-slate-50"><tr>
                            <th class="p-4 font-semibold text-slate-600 text-sm w-2/5">Configuração</th>
                            <th class="p-4 font-semibold text-slate-600 text-sm">Valor</th>
                            <th class="p-4 font-semibold text-slate-600 text-sm text-right">Ação</th>
                        </tr></thead>
                        <tbody id="settings-table-body">${tableRows}</tbody>
                    </table></div>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800">${SETTINGS_MAP['HELP_MESSAGE'].label}</h3>
                        <p class="text-sm text-slate-500 mt-1">${SETTINGS_MAP['HELP_MESSAGE'].description}</p>
                    </div>
                    <div class="p-4">
                        <textarea id="helpMessageText" class="form-input w-full" rows="6">${helpMessageConfig ? helpMessageConfig.Valor : ''}</textarea>
                    </div>
                    <div class="p-4 border-t border-slate-200 bg-slate-50 text-right">
                        <button id="saveHelpMessageBtn" class="btn btn-primary">Salvar Mensagem de Ajuda</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-red-200">
                    <div class="p-4 border-b border-red-200">
                        <h3 class="text-lg font-semibold text-red-800">Manutenção do Sistema</h3>
                        <p class="text-sm text-slate-500 mt-1">Ações perigosas que afetam os dados do sistema.</p>
                    </div>
                    <div class="p-4 flex justify-between items-center">
                        <div>
                            <p class="font-medium text-slate-700">Arquivar e Limpar Agendamentos</p>
                            <p class="text-sm text-slate-500">Move todos os agendamentos para uma nova aba de backup e limpa a aba atual para melhorar a performance.</p>
                        </div>
                        <button id="archiveBtn" class="btn btn-danger"><i class="fa-solid fa-archive mr-2"></i>Arquivar Agora</button>
                    </div>
                </div>
            </div>`;

        const tableBody = container.querySelector('#settings-table-body');

        tableBody.addEventListener('click', async e => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const row = button.closest('tr');
            const key = row.dataset.key;
            const action = button.dataset.action;
            const valueCell = row.querySelector('td:nth-child(2)');
            
            if (action === 'edit') {
                const currentValue = valueCell.querySelector('span').textContent;
                valueCell.innerHTML = `<input type="text" class="form-input" value="${currentValue}">`;
                button.textContent = 'Salvar';
                button.dataset.action = 'save';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-primary');
            } else if (action === 'save') {
                const value = valueCell.querySelector('input').value;
                this.showLoader('Salvando...');
                try {
                    await callApi('updateSetting', { key, value });
                    this.showNotification('success', 'Sucesso!', 'Configuração salva.');
                    await this.refreshData('master-settings');
                } catch (err) {
                    this.showNotification('error', 'Erro', err.message);
                } finally {
                    this.hideLoader();
                }
            }
        });

        tableBody.addEventListener('change', async e => {
            if (!e.target.classList.contains('setting-toggle')) return;

            const row = e.target.closest('tr');
            const key = row.dataset.key;
            const isChecked = e.target.checked;
            const value = isChecked ? 'SIM' : 'NAO';
            
            this.showLoader('Salvando...');
            try {
                await callApi('updateSetting', { key, value });
                this.showNotification('success', 'Sucesso!', 'Configuração salva.');
                await this.refreshData('master-settings');
            } catch (err) {
                this.showNotification('error', 'Erro', err.message);
            } finally {
                this.hideLoader();
            }
        });
        
        document.getElementById('saveHelpMessageBtn').addEventListener('click', async () => {
            const value = document.getElementById('helpMessageText').value;
            this.showLoader('Salvando...');
            try {
                await callApi('updateSetting', { key: 'HELP_MESSAGE', value });
                this.showNotification('success', 'Sucesso!', 'Mensagem de ajuda salva.');
                await this.refreshData('master-settings');
            } catch (err) {
                this.showNotification('error', 'Erro', err.message);
            } finally {
                this.hideLoader();
            }
        });

        document.getElementById('archiveBtn').addEventListener('click', () => {
            const message = "Você tem certeza? Esta ação moverá TODOS os agendamentos da aba principal para uma nova aba de backup. A aba 'Agendamentos' ficará vazia. Esta ação não pode ser desfeita.";
            this.confirmAction(message, async () => {
                this.showLoader('Arquivando... Isso pode levar alguns minutos.');
                try {
                    const response = await callApi('archiveAndClearAppointments');
                    this.showNotification('success', 'Processo Concluído', response.message);
                    await this.refreshData('master-dashboard');
                } catch (err) {
                    this.showNotification('error', 'Erro ao Arquivar', err.message);
                } finally {
                    this.hideLoader();
                }
            });
        });
    },

    renderMasterImport() {
        document.getElementById('view-title').textContent = 'Importar Dados';
        this.elements.mainContent.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 max-w-3xl mx-auto">
                <h3 class="text-xl font-bold text-slate-800">Importar Agendamentos Antigos</h3>
                <div class="mt-4 space-y-4 text-slate-600 prose prose-slate max-w-none">
                    <p>Esta ferramenta permite migrar os seus agendamentos de um sistema antigo para o novo formato.</p>
                    <ol class="list-decimal list-inside space-y-2">
                        <li>Crie uma nova aba na sua planilha com o nome exato: <code>Importar_Agendamentos</code></li>
                        <li>Na primeira linha, coloque os cabeçalhos: <code>Data, Hora, Nome_Cliente, Telefone_WhatsApp, Servico, Profissional, Status, Observacoes</code></li>
                        <li>Cole os seus dados antigos abaixo. O nome na coluna "Profissional" deve corresponder exatamente ao "Nome_Completo" na sua aba "Profissionais".</li>
                    </ol>
                    <p class="font-semibold text-red-600 border-l-4 border-red-500 pl-4">Atenção: Este processo não pode ser desfeito. Faça uma cópia de segurança da sua planilha antes de continuar.</p>
                </div>
                <div class="mt-6"><button id="startImportBtn" class="btn btn-primary"><i class="fa-solid fa-upload mr-2"></i>Iniciar Importação</button></div>
            </div>`;
        document.getElementById('startImportBtn').addEventListener('click', () => {
            this.confirmAction('Tem certeza que deseja iniciar a importação? Esta ação não pode ser desfeita.', async () => {
                this.showLoader('Importando...');
                try {
                    const res = await callApi('importOldAppointments');
                    this.showNotification('success', 'Importação Concluída', `${res.imported} importados, ${res.failed} falhas.`);
                    await this.refreshData('master-dashboard');
                } catch (err) { this.showNotification('error', 'Erro na Importação', err.message); } finally { this.hideLoader(); }
            });
        });
    }
});
</script>
