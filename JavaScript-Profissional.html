<script>
// ========================================================
// ARQUIVO: JavaScript-Profissional.html
// Contém todas as funções de renderização para as telas do perfil Profissional.
// ========================================================
Object.assign(App, {
    renderProfessionalAgenda() {
        document.getElementById('view-title').textContent = 'Fila de Atendimento';
        const container = this.elements.mainContent;

        if (!this.state.data.agendaData) {
            container.innerHTML = `<div class="flex justify-center items-center p-8"><i class="fa-solid fa-spinner animate-spin text-2xl text-slate-400 mr-3"></i><span class="text-slate-500">Carregando agenda...</span></div>`;
            return;
        }

        const intervalConfig = this.state.data.config.find(c => c.Chave === 'AGENDA_REFRESH_INTERVAL_SECONDS');
        const intervalSeconds = intervalConfig ? parseInt(intervalConfig.Valor, 10) : 15;
        const intervalMilliseconds = (isNaN(intervalSeconds) || intervalSeconds <= 0) ? 15000 : intervalSeconds * 1000;

        const { currentlyServing, nextInLine, priorityAppointments, completedToday, waitingList } = this.state.data.agendaData;
        
        let mainCardHtml = '';

        if (currentlyServing) {
            const prof = this.state.data.professionals.find(p => p.ID_Profissional === currentlyServing.ID_Profissional_Chamada);
            const profName = prof ? prof.Nome_Completo.split(' ')[0] : 'Outro';
            mainCardHtml = `
                <div class="bg-green-50 border-2 border-green-500 p-6 rounded-2xl text-center shadow-lg h-full flex flex-col justify-center">
                    <p class="text-sm font-semibold text-green-700">EM ATENDIMENTO (por ${profName})</p>
                    <h3 class="text-3xl md:text-4xl font-bold text-slate-850 mt-2">${currentlyServing.Nome_Cliente}</h3>
                    <p class="text-green-900/80 mt-1">Ficha: ${String(currentlyServing.Numero_Ficha).padStart(3, '0')} - ${currentlyServing.Servico}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                        <button data-action="recall-client" data-id="${currentlyServing.ID_Agendamento}" class="btn btn-secondary !py-3">
                            <i class="fa-solid fa-bullhorn mr-2"></i>Chamar Novamente
                        </button>
                        <button data-action="complete-appointment" data-id="${currentlyServing.ID_Agendamento}" class="btn btn-success !py-3">
                            <i class="fa-solid fa-check mr-2"></i>Concluir Atendimento
                        </button>
                    </div>
                </div>`;
        } else if (nextInLine) {
            const isPriority = nextInLine.Prioridade === 'SIM';
            const cardBg = isPriority ? 'bg-yellow-50 border-yellow-500' : 'bg-blue-50 border-blue-500';
            const textColor = isPriority ? 'text-yellow-700' : 'text-blue-700';
            const subTextColor = isPriority ? 'text-yellow-900/80' : 'text-blue-900/80';
            const buttonClass = isPriority ? 'bg-yellow-500 text-white hover:bg-yellow-600' : 'btn-primary';
            const titleText = isPriority ? 'PRÓXIMO (PRIORIDADE)' : 'PRÓXIMO (FILA NORMAL)';
            mainCardHtml = `
                <div class="${cardBg} border-2 p-6 rounded-2xl text-center shadow-lg h-full flex flex-col justify-center">
                    <p class="text-sm font-semibold ${textColor}">${titleText}</p>
                    <h3 class="text-3xl md:text-4xl font-bold text-slate-850 mt-2">${nextInLine.Nome_Cliente}</h3>
                    <p class="${subTextColor} mt-1">Ficha: ${String(nextInLine.Numero_Ficha).padStart(3, '0')} - ${nextInLine.Servico}</p>
                    <button data-action="call-client" data-id="${nextInLine.ID_Agendamento}" class="btn ${buttonClass} w-full mt-6 !py-4 !text-lg">
                        <i class="fa-solid fa-bullhorn mr-3"></i>CHAMAR PRÓXIMO
                    </button>
                </div>`;
        } else {
            mainCardHtml = `
                <div class="bg-slate-50 p-6 rounded-lg text-center border border-slate-200 h-full flex flex-col justify-center min-h-[250px]">
                    <i class="fa-solid fa-couch text-4xl text-slate-400 mx-auto mb-4"></i>
                    <p class="text-slate-500 font-medium text-xl">Fila de atendimento vazia.</p>
                    <p class="text-sm text-slate-400 mt-2">Aguardando novos clientes para hoje.</p>
                </div>`;
        }

        let priorityListHtml = ``;
        if (priorityAppointments && priorityAppointments.length > 0) {
            priorityListHtml = priorityAppointments.map(appt => `
                <div class="flex items-center justify-between gap-4 p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                    <div>
                        <p class="font-semibold text-slate-800">${appt.Nome_Cliente}</p>
                        <p class="text-xs text-slate-600">Ficha: ${String(appt.Numero_Ficha).padStart(3, '0')} - ${appt.Servico}</p>
                    </div>
                </div>`).join('');
        } else {
            priorityListHtml = `<p class="text-slate-500 text-sm text-center py-4">Nenhum atendimento prioritário na fila.</p>`;
        }

        let waitingListHtml = ``;
        if (waitingList && waitingList.length > 0) {
            waitingListHtml = waitingList.map(appt => `
                <div class="flex items-center justify-between p-3 border-b border-slate-100 last:border-b-0">
                    <div>
                        <span class="font-medium text-slate-700">Ficha ${String(appt.Numero_Ficha).padStart(3, '0')}</span>
                        <span>- ${appt.Nome_Cliente}</span>
                    </div>
                    ${appt.Prioridade === 'SIM' ? '<i class="fa-solid fa-star text-yellow-400" title="Prioritário"></i>' : ''}
                </div>`).join('');
        } else {
            waitingListHtml = `<p class="text-slate-500 text-sm p-4">A fila de espera está vazia.</p>`;
        }

        let completedHtml = ``;
        if (completedToday && completedToday.length > 0) {
            completedHtml = completedToday.map(appt => `
                <div class="flex items-center justify-between p-3 border-b border-slate-100 last:border-b-0">
                    <div>
                        <p class="font-medium text-slate-700">${appt.Nome_Cliente}</p>
                        <p class="text-sm text-slate-500">Ficha: ${String(appt.Numero_Ficha).padStart(3, '0')} - ${appt.Servico}</p>
                    </div>
                    <span class="text-slate-500 font-medium">${appt.Hora}</span>
                </div>`).join('');
        } else {
            completedHtml = `<p class="text-slate-500 text-sm p-4">Nenhum cliente atendido hoje.</p>`;
        }
        
        container.innerHTML = `
            <div id="professional-agenda-view" class="max-w-7xl mx-auto space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">${mainCardHtml}</div>
                    <div class="bg-white p-4 rounded-xl shadow-md border border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-3 flex items-center justify-between">
                            <span class="flex items-center"><i class="fa-solid fa-star text-yellow-400 mr-3"></i>Prioritários</span>
                            <span class="text-sm font-normal bg-slate-100 text-slate-600 px-2 py-1 rounded-md">${priorityAppointments.length} na fila</span>
                        </h3>
                        <div class="space-y-3 max-h-[280px] overflow-y-auto pr-2">${priorityListHtml}</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <details class="bg-white rounded-xl shadow-md border border-slate-200" open>
                        <summary class="p-4 font-semibold text-slate-800 cursor-pointer flex justify-between items-center">
                            <span><i class="fa-solid fa-users mr-2 text-slate-500"></i>Fila de Espera</span>
                            <span class="text-sm font-normal bg-slate-100 text-slate-600 px-2 py-1 rounded-md">${waitingList.length} aguardando</span>
                        </summary>
                        <div class="border-t border-slate-200 max-h-60 overflow-y-auto">${waitingListHtml}</div>
                    </details>
                    <details class="bg-white rounded-xl shadow-md border border-slate-200" open>
                        <summary class="p-4 font-semibold text-slate-800 cursor-pointer flex justify-between items-center">
                            <span><i class="fa-solid fa-check-double mr-2 text-green-500"></i>Atendidos Hoje</span>
                            <span class="text-sm font-normal bg-slate-100 text-slate-600 px-2 py-1 rounded-md">${completedToday.length} atendido(s)</span>
                        </summary>
                        <div class="border-t border-slate-200 max-h-60 overflow-y-auto">${completedHtml}</div>
                    </details>
                </div>
            </div>
        `;
        
        container.querySelector('#professional-agenda-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button || this.state.isCallingClient) return;

            const action = button.dataset.action;
            const id = button.dataset.id;
            
            if (action === 'call-client') {
                this.state.isCallingClient = true;
                button.disabled = true;
                button.innerHTML = `<i class="fa-solid fa-spinner animate-spin mr-2"></i> Chamando...`;

                try {
                    const response = await callApi('callClientAndUpdateStatus', { appointmentId: id, callingProfId: this.state.currentUser.id });
                    this.state.data.agendaData = response.newAgendaData;
                    this.renderProfessionalAgenda(); 
                } catch(err) {
                    this.showNotification('error', 'Erro ao Chamar', err.message);
                    this.renderProfessionalAgenda(); 
                } finally {
                    this.state.isCallingClient = false;
                }
            } 
            else if (action === 'recall-client') { 
                button.disabled = true;
                const originalText = button.innerHTML;
                button.innerHTML = `<i class="fa-solid fa-spinner animate-spin mr-2"></i> Chamando...`;
                try {
                    await callApi('recallClient', { appointmentId: id });
                    this.showNotification('success', 'Sucesso!', 'Cliente chamado novamente no painel.');
                } catch(err) {
                    this.showNotification('error', 'Erro ao Chamar', err.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
            else if (action === 'complete-appointment') {
                this.confirmAction("Deseja marcar este atendimento como 'Concluído'?", async () => {
                    this.showLoader('Finalizando...');
                    try {
                        await callApi('updateAppointmentStatus', { appointmentId: id, newStatus: 'Concluído' });
                        this.showNotification('success', 'Sucesso!', 'Atendimento concluído.');
                        
                        const newAgendaData = await callApi('getAgendaUpdate', { profId: this.state.currentUser.id });
                        this.state.data.agendaData = newAgendaData;
                        this.renderProfessionalAgenda();

                    } catch (err) {
                        this.showNotification('error', 'Erro', err.message);
                    } finally {
                        this.hideLoader();
                    }
                });
            }
        });

        const checkForUpdates = async () => {
            if (this.state.currentView !== 'professional-agenda' || this.state.isCallingClient) return;
            try {
                const latestUpdate = await callApi('getLatestUpdateTimestamp');
                if (latestUpdate > this.state.lastUpdateTimestamp) {
                    this.state.lastUpdateTimestamp = latestUpdate;
                    await this.refreshData('professional-agenda', true);
                }
            } catch (e) {
                console.error("Falha ao verificar atualizações na agenda:", e);
                if (this.state.agendaRefreshInterval) clearInterval(this.state.agendaRefreshInterval);
            }
        };
        
        if (this.state.agendaRefreshInterval) clearInterval(this.state.agendaRefreshInterval);
        this.state.agendaRefreshInterval = setInterval(checkForUpdates, intervalMilliseconds);
    },
    
    renderProfessionalClientSearch() {
        document.getElementById('view-title').textContent = 'Clientes Cadastrados';
        const container = this.elements.mainContent;
        let currentPage = 1;
        const pageSize = 50;

        container.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200 max-w-4xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-4">
                    <h3 class="text-xl font-bold text-slate-800">Gerenciar Clientes</h3>
                    <div class="flex w-full md:w-auto gap-2">
                        <input type="text" id="searchTerm" class="form-input w-full md:w-64" placeholder="Filtrar por nome ou telefone...">
                        <button id="addNewClientBtn" class="btn btn-primary flex-shrink-0"><i class="fa-solid fa-plus mr-2"></i>Novo</button>
                    </div>
                </div>
                <div id="clientSearchResults" class="mt-6 border-t border-slate-200 pt-4 min-h-[300px]">
                    <p class="text-slate-500 text-center">Buscando clientes...</p>
                </div>
                <div id="client-pagination-container" class="pt-4 border-t border-slate-200 flex justify-between items-center mt-4">
                </div>
            </div>
        `;
        const searchInput = container.querySelector('#searchTerm');
        const resultsContainer = container.querySelector('#clientSearchResults');
        const paginationContainer = container.querySelector('#client-pagination-container');
        
        const fetchAndRenderClients = async (term = '', page = 1) => {
            resultsContainer.innerHTML = '<div class="flex justify-center items-center p-8"><i class="fa-solid fa-spinner animate-spin text-2xl text-slate-400 mr-3"></i><span class="text-slate-500">Buscando clientes...</span></div>';
            paginationContainer.innerHTML = '';
            currentPage = page;

            try {
                const response = await callApi('searchClients', { searchTerm: term, page: currentPage, pageSize: pageSize });
                
                if (response.success && response.clients.length > 0) {
                    resultsContainer.innerHTML = response.clients.map(client => `
                        <div class="p-3 border-b border-slate-100 flex justify-between items-center hover:bg-slate-50">
                            <div>
                                <p class="font-medium text-slate-800">${client.Nome_Completo}</p>
                                <p class="text-sm text-slate-500">${client.Telefone_WhatsApp}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-action="edit-client" data-client-id="${client.ID_Cliente}" class="btn btn-secondary !py-1 !px-3">Editar</button>
                                <button data-action="view-notes" data-client-id="${client.ID_Cliente}" data-name="${client.Nome_Completo}" class="btn btn-secondary !py-1 !px-3">Anotações</button>
                            </div>
                        </div>
                    `).join('');

                    const totalCount = response.totalCount;
                    const totalPages = Math.ceil(totalCount / pageSize);
                    
                    let paginationHtml = `<span class="text-sm text-slate-600">Página ${currentPage} de ${totalPages} (${totalCount} registros)</span>`;
                    
                    if (totalPages > 1) {
                        paginationHtml += `<div class="flex gap-2">
                            <button id="prevPageBtn" class="btn btn-secondary !px-3" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>
                            <button id="nextPageBtn" class="btn btn-secondary !px-3" ${currentPage === totalPages ? 'disabled' : ''}>Próxima</button>
                        </div>`;
                    }
                    paginationContainer.innerHTML = paginationHtml;

                    if (document.getElementById('prevPageBtn')) {
                        document.getElementById('prevPageBtn').addEventListener('click', () => fetchAndRenderClients(searchInput.value, currentPage - 1));
                    }
                    if (document.getElementById('nextPageBtn')) {
                        document.getElementById('nextPageBtn').addEventListener('click', () => fetchAndRenderClients(searchInput.value, currentPage + 1));
                    }

                } else {
                    resultsContainer.innerHTML = '<p class="text-slate-500 text-center">Nenhum cliente encontrado.</p>';
                }
            } catch (err) {
                this.showNotification('error', 'Erro na Busca', err.message);
                resultsContainer.innerHTML = '<p class="text-red-500 text-center">Ocorreu um erro ao buscar.</p>';
            }
        };
        
        container.querySelector('#addNewClientBtn').addEventListener('click', () => {
            this.renderClientForm(null, 'professional-client-search');
        });

        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchAndRenderClients(searchInput.value, 1);
            }, 300);
        });
        
        resultsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const clientId = button.dataset.clientId;
            const clientName = button.dataset.name;

            if (action === 'view-notes') {
                this.renderClientNotesModal(clientId, clientName, 'professional-client-search');
            } else if (action === 'edit-client') {
                this.renderClientForm(clientId, 'professional-client-search');
            }
        });

        fetchAndRenderClients();
    },
    
    async renderClientNotesModal(clientId, clientName, returnView) {
        this.showLoader('Buscando anotações...');
        try {
            const response = await callApi('getClientNotes', { clientId });
            if (!response.success) throw new Error(response.message);

            const notesHtml = response.notes.length > 0 ? response.notes.map(note => `
                <div class="note-item p-3 bg-slate-50 rounded-lg border border-slate-200" data-note-id="${note.ID_Anotacao}">
                    <div class="note-display">
                        <p class="text-sm text-slate-800 whitespace-pre-wrap">${note.Anotacao}</p>
                        <div class="text-xs text-slate-500 mt-2 flex justify-between items-center">
                            <span>-- ${note.Nome_Profissional} em ${note.DataFormatada}</span>
                            <div class="note-actions space-x-2">
                                <button class="btn-icon !w-7 !h-7" data-action="edit-note" title="Editar"><i class="fa-solid fa-pencil"></i></button>
                                <button class="btn-icon !w-7 !h-7" data-action="delete-note" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="note-edit hidden">
                        <textarea class="form-input w-full">${note.Anotacao}</textarea>
                        <div class="flex justify-end gap-2 mt-2">
                            <button class="btn btn-secondary !py-1 !px-3 text-xs" data-action="cancel-edit">Cancelar</button>
                            <button class="btn btn-success !py-1 !px-3 text-xs" data-action="save-edit">Salvar</button>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="text-slate-500 text-center py-4">Nenhuma anotação encontrada.</p>';

            const modalContent = `
                <div id="notes-modal-content" class="space-y-4">
                    <div>
                        <h4 class="text-md font-semibold text-slate-700 mb-2">Histórico Anterior</h4>
                        <div class="space-y-3 max-h-60 overflow-y-auto pr-2">${notesHtml}</div>
                    </div>
                    <form id="newNoteForm" class="border-t border-slate-200 pt-4">
                        <label for="newNote" class="form-label">Adicionar Nova Anotação</label>
                        <textarea id="newNote" rows="4" class="form-input mt-1" required></textarea>
                        <div class="flex justify-end gap-4 pt-4 mt-4">
                            <button type="button" class="btn btn-secondary" onclick="App.closeModal()">Fechar Janela</button>
                            <button type="submit" class="btn btn-primary">Salvar Anotação</button>
                        </div>
                    </form>
                </div>
            `;
            this.openModal(`Anotações de: ${clientName}`, modalContent, 'max-w-2xl');

            const notesContainer = document.getElementById('notes-modal-content');

            notesContainer.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const action = button.dataset.action;
                const noteItem = button.closest('.note-item');
                const noteId = noteItem?.dataset.noteId;

                if (action === 'delete-note') {
                    this.confirmAction('Deseja excluir esta anotação permanentemente?', async () => {
                        this.showLoader('Excluindo...');
                        try {
                            const resp = await callApi('deleteClientNote', { noteId });
                            if (!resp.success) throw new Error(resp.message);
                            this.showNotification('success', 'Sucesso', 'Anotação excluída.');
                            this.closeModal();
                            this.renderClientNotesModal(clientId, clientName, returnView);
                        } catch (err) { this.showNotification('error', 'Erro', err.message); } 
                        finally { this.hideLoader(); }
                    });
                } else if (action === 'edit-note') {
                    noteItem.querySelector('.note-display').classList.add('hidden');
                    noteItem.querySelector('.note-edit').classList.remove('hidden');
                } else if (action === 'cancel-edit') {
                    noteItem.querySelector('.note-display').classList.remove('hidden');
                    noteItem.querySelector('.note-edit').classList.add('hidden');
                } else if (action === 'save-edit') {
                    const newText = noteItem.querySelector('textarea').value;
                    this.showLoader('Salvando...');
                    try {
                        const resp = await callApi('updateClientNote', { noteId, newText });
                        if (!resp.success) throw new Error(resp.message);
                        this.showNotification('success', 'Sucesso', 'Anotação atualizada.');
                        this.closeModal();
                        this.renderClientNotesModal(clientId, clientName, returnView);
                    } catch (err) { this.showNotification('error', 'Erro', err.message); } 
                    finally { this.hideLoader(); }
                }
            });

            document.getElementById('newNoteForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newNote = document.getElementById('newNote').value;
                this.showLoader('Salvando...');
                try {
                    const data = {
                        clientId: clientId, 
                        clientName: clientName,
                        note: newNote, 
                        professionalId: this.state.currentUser.id,
                        professionalName: this.state.currentUser.name
                    };
                    const resp = await callApi('saveClientNote', { data });
                    if (!resp.success) throw new Error(resp.message);
                    this.showNotification('success', 'Sucesso!', 'Nova anotação salva.');
                    this.closeModal();
                    this.renderClientNotesModal(clientId, clientName, returnView);
                } catch(err) { this.showNotification('error', 'Erro', err.message); } 
                finally { this.hideLoader(); }
            });

        } catch (err) {
            this.showNotification('error', 'Erro ao buscar', err.message);
        } finally {
            this.hideLoader();
        }
    },
    
    async renderClientForm(clientId, returnView) {
        this.showLoader('Carregando...');
        const isEditing = !!clientId;
        let client = {};

        try {
            if (isEditing) {
                client = await callApi('getClientById', { clientId });
                if (!client) throw new Error('Cliente não encontrado.');
            }
            this.hideLoader();
            const title = isEditing ? 'Editar Cliente' : 'Adicionar Novo Cliente';
            const formHTML = `
                <form id="clientForm" class="space-y-4">
                    <input type="hidden" id="clientId" value="${client.ID_Cliente || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="form-label">Nome Completo</label><input type="text" id="clientName" class="form-input" value="${client.Nome_Completo || ''}" required></div>
                        <div><label class="form-label">Telefone (WhatsApp)</label><input type="tel" id="clientPhone" class="form-input" value="${client.Telefone_WhatsApp || ''}"></div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4 border-t border-slate-200 mt-4">
                        <button type="button" class="btn btn-secondary" onclick="App.closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Cliente</button>
                    </div>
                </form>
            `;
            this.openModal(title, formHTML, 'max-w-xl');

            document.getElementById('clientForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                this.showLoader('Salvando...');
                const clientData = {
                    ID_Cliente: document.getElementById('clientId').value,
                    Nome_Completo: document.getElementById('clientName').value,
                    Telefone_WhatsApp: document.getElementById('clientPhone').value,
                    Data_Cadastro: client.Data_Cadastro
                };
                try {
                    const response = await callApi('addOrUpdateClient', { clientData });
                    if (response.success) {
                        this.showNotification('success', 'Sucesso!', `Cliente ${isEditing ? 'atualizado' : 'adicionado'}.`);
                        this.closeModal();
                        this.navigateTo(returnView, true);
                    } else { throw new Error(response.message); }
                } catch (err) {
                    this.showNotification('error', 'Erro ao Salvar', err.message);
                } finally { this.hideLoader(); }
            });
        } catch (err) {
            this.showNotification('error', 'Erro', err.message);
            this.hideLoader();
        }
    }
});

// ========================================================
// INICIALIZAÇÃO DO APP
// ========================================================
document.addEventListener('DOMContentLoaded', () => App.init());
</script>
